<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ruud's Metronome</title>

  <style>
    :root {
      --gray-100: #f9f9f9;
      --gray-400: #bdbdbd;
      --gray-600: #757575;
      --gray-800: #424242;
      --gray-900: #212121;
      --accent-green: #34A853;
      --accent-green-dark: #0F9D58;
      --accent-red: #EA4335;
      --accent-red-dark: #C5221F;
      --wrap-max: 650px;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", Arial, sans-serif;
      background: var(--gray-100);
      color: var(--gray-900);
      margin: 0;
      padding: 20px 16px;
      display: flex;
      flex-direction: column;
      align-items: center;
      transition: background 0.3s, color 0.3s;
      -webkit-user-select: none;
      user-select: none;
    }

    .wrap {
      width: 100%;
      max-width: var(--wrap-max);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 16px;
      box-sizing: border-box;
    }

    h1 {
      font-size: 2rem;
      font-weight: 600;
      margin: 0 0 4px 0;
      text-align: center;
      color: var(--gray-800);
      transition: color 0.3s;
      width: 100%;
    }

    .switches, .control-row, .buttons {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 20px;
      width: 100%;
    }

    .switch-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .switch-label {
      font-size: 0.9rem;
      line-height: 1;
    }

    /* Slider */
    input[type=range] {
      flex: 1;
      min-width: 120px;
      max-width: 220px;
      appearance: none;
      height: 6px;
      border-radius: 3px;
      background: var(--gray-400);
      cursor: pointer;
      --min: 30;
      --max: 300;
      --value: 100;
    }
    input[type=range]::-webkit-slider-runnable-track {
      height: 6px;
      border-radius: 3px;
      background: linear-gradient(
        to right,
        var(--accent-green) 0%,
        var(--accent-green) calc((var(--value) - var(--min)) / (var(--max) - var(--min)) * 100%),
        var(--gray-400) calc((var(--value) - var(--min)) / (var(--max) - var(--min)) * 100%),
        var(--gray-400) 100%
      );
    }
    input[type=range]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: var(--accent-green);
      border: none;
      margin-top: -6px;
    }

    /* BPM Input & Tap Button (same height/appearance) */
    #bpmInput, #tapTempo {
      height: 36px; /* slightly bigger for touch */
      line-height: 1;
      padding: 0 10px;
      border: 1px solid var(--gray-400);
      border-radius: 6px;
      font-size: 0.9rem;
      background: var(--gray-100);
      color: var(--gray-900);
      cursor: pointer;
      box-sizing: border-box;
    }
    #bpmInput { width: 70px; text-align: center; }
    #tapTempo { min-width: 80px; }
    #tapTempo:hover { background: var(--gray-400); color: var(--gray-100); }

    /* Selects */
    select {
      height: 36px;
      padding: 0 10px;
      border: 1px solid var(--gray-400);
      border-radius: 6px;
      font-size: 0.9rem;
      background: var(--gray-100);
      color: var(--gray-900);
      cursor: pointer;
      box-sizing: border-box;
    }

    /* Switch */
    .switch { position: relative; width: 46px; height: 24px; }
    .switch input { display: none; }
    .slider {
      position: absolute; inset: 0;
      background: var(--gray-400);
      border-radius: 24px; transition: background 0.3s;
    }
    .slider:before {
      content: "";
      position: absolute;
      height: 18px; width: 18px;
      left: 3px; bottom: 3px;
      background: var(--gray-100);
      border-radius: 50%;
      transition: .3s;
    }
    input:checked + .slider { background: var(--accent-green); }
    input:checked + .slider:before { transform: translateX(22px); }

    /* Start/Stop */
    button {
      padding: 10px 20px;
      border: none;
      border-radius: 9999px;
      font-size: 1rem;
      cursor: pointer;
      transition: background 0.3s;
    }
    #toggleBtn.start { background: var(--accent-green); color: white; }
    #toggleBtn.start:hover { background: var(--accent-green-dark); }
    #toggleBtn.stop { background: var(--accent-red); color: white; }
    #toggleBtn.stop:hover { background: var(--accent-red-dark); }

    /* Instructions Card */
    .instructions {
      font-size: 0.8rem;
      color: var(--gray-400);
      text-align: left;
      display: inline-block;
      margin: 40px auto 0 auto;
      padding: 12px 16px;
      border: 1px solid var(--gray-400);
      border-radius: 8px;
      -webkit-user-select: text;
      user-select: text;
    }

    /* Dark mode */
    body.dark-mode { background: var(--gray-900); color: var(--gray-100); }
    body.dark-mode h1 { color: var(--gray-100); }
    body.dark-mode .instructions {
      color: var(--gray-600);
      border-color: var(--gray-600);
    }
    body.dark-mode #bpmInput,
    body.dark-mode #tapTempo,
    body.dark-mode select {
      background: var(--gray-800);
      color: var(--gray-100);
      border-color: var(--gray-600);
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Ruud’s Metronome</h1>

    <!-- Switches -->
    <div class="switches">
      <div class="switch-item">
        <label class="switch">
          <input type="checkbox" id="slapSwitch">
          <span class="slider"></span>
        </label>
        <span class="switch-label">Slap</span>
      </div>
      <div class="switch-item">
        <label class="switch">
          <input type="checkbox" id="darkSwitch">
          <span class="slider"></span>
        </label>
        <span class="switch-label">Dark Mode</span>
      </div>
    </div>

    <!-- BPM Controls -->
    <div class="control-row">
      <input type="range" id="bpmSlider" min="30" max="300" value="100">
      <input type="number" id="bpmInput" min="30" max="300" value="100">
      <button id="tapTempo">Tap</button>
    </div>

    <!-- Beats & Ramp -->
    <div class="control-row">
      <select id="beats">
        <option value="2">2/4</option>
        <option value="3">3/4</option>
        <option value="4" selected>4/4</option>
        <option value="5">5/4</option>
        <option value="6">6/8</option>
      </select>
      <select id="ramp">
        <option value="off">Ramp off</option>
        <option value="up">Ramp up</option>
        <option value="down">Ramp down</option>
      </select>
      <select id="rampStep" style="display:none;">
        <option value="1">1</option><option value="2">2</option>
        <option value="3">3</option><option value="4">4</option>
        <option value="5">5</option>
      </select>
    </div>

    <!-- Transport -->
    <div class="buttons">
      <button id="toggleBtn" class="start">Start</button>
    </div>

    <!-- Instructions Card -->
    <div class="instructions">
      Press <b>Space</b> to start and stop.<br>
      Use the <b>arrow keys</b> to change the speed:<br>
      – Left / Down = -1 BPM<br>
      – Right / Up = +1 BPM<br>
      Hold <b>Shift</b> with arrows for -5 / +5 BPM.<br>
      Tap the <b>T</b> key a few times to set your own tempo.
    </div>
  </div>

  <!-- JavaScript logic unchanged -->
  <script>
    let audioCtx=null, baseBuffer=null, slapNormalBuffer=null, slapAccentBuffer=null, samplesReady=false;
    const BASE_URL="https://raw.githubusercontent.com/rpmoers/ruuds-metronome/main/metronome-85688.mp3";
    const SLAP_NORMAL_URL="https://raw.githubusercontent.com/rpmoers/ruuds-metronome/main/Alesis-S4-Plus-Muted-Pops-C3.wav";
    const SLAP_ACCENT_URL="https://raw.githubusercontent.com/rpmoers/ruuds-metronome/main/Korg-N1R-Slap-It-C1.wav";

    async function loadSample(url){const res=await fetch(url);if(!res.ok) throw new Error("HTTP "+res.status);const arr=await res.arrayBuffer();return await audioCtx.decodeAudioData(arr);}
    async function loadSamplesOnce(){if(samplesReady)return;if(!audioCtx) audioCtx=new (window.AudioContext||window.webkitAudioContext)();baseBuffer=await loadSample(BASE_URL);slapNormalBuffer=await loadSample(SLAP_NORMAL_URL);slapAccentBuffer=await loadSample(SLAP_ACCENT_URL);samplesReady=true;}
    function playClick(accent=false,time=0){if(!audioCtx||!samplesReady)return;const slapMode=document.getElementById("slapSwitch").checked;const src=audioCtx.createBufferSource();const gain=audioCtx.createGain();if(slapMode){src.buffer=accent?slapAccentBuffer:slapNormalBuffer;gain.gain.value=1.0;}else{src.buffer=baseBuffer;gain.gain.value=accent?1.6:1.0;src.playbackRate.value=accent?1.1:1.0;}src.connect(gain).connect(audioCtx.destination);src.start(time);}
    let running=false,bpm=100,beatsPerMeasure=4,currentBeat=0,barCounter=0,nextNoteTime=0.0,timerID;
    const bpmSlider=document.getElementById("bpmSlider"),bpmInput=document.getElementById("bpmInput"),beatsSelect=document.getElementById("beats"),rampSelect=document.getElementById("ramp"),rampStep=document.getElementById("rampStep"),toggleBtn=document.getElementById("toggleBtn"),tapBtn=document.getElementById("tapTempo");
    function clamp(v,lo,hi){return Math.min(hi,Math.max(lo,v||0));}
    function updateBpm(val){bpm=clamp(val,30,300);bpmSlider.value=bpm;bpmInput.value=bpm;bpmSlider.style.setProperty("--value", bpm);}
    bpmSlider.addEventListener("input",()=>updateBpm(parseInt(bpmSlider.value,10)));
    bpmInput.addEventListener("change",()=>{const v=parseInt(bpmInput.value,10);if(!isNaN(v)) updateBpm(v);});
    beatsSelect.addEventListener("change",()=>{beatsPerMeasure=parseInt(beatsSelect.value,10);currentBeat=0;});
    rampSelect.addEventListener("change",()=>{rampStep.style.display=(rampSelect.value==="up"||rampSelect.value==="down")?"inline-block":"none";});
    let lastTap=0,tapIntervals=[];tapBtn.addEventListener("click",()=>{const now=Date.now();if(lastTap){tapIntervals.push(now-lastTap);if(tapIntervals.length>4)tapIntervals.shift();const avg=tapIntervals.reduce((a,b)=>a+b,0)/tapIntervals.length;const calc=Math.round(60000/avg);if(calc>0&&isFinite(calc)) updateBpm(calc);}lastTap=now;});
    const lookahead=25.0,scheduleAheadTime=0.1;
    function nextNote(){const secPerBeat=60.0/bpm;nextNoteTime+=secPerBeat;currentBeat=(currentBeat+1)%beatsPerMeasure;}
    function scheduleNote(beat,time){playClick(beat===0,time);}
    function scheduler(){if(!running||!audioCtx)return;while(nextNoteTime<audioCtx.currentTime+scheduleAheadTime){scheduleNote(currentBeat,nextNoteTime);nextNote();if(currentBeat===0){barCounter++;if(barCounter%4===0){const step=parseInt(rampStep.value||"1",10);if(rampSelect.value==="up")updateBpm(bpm+step);if(rampSelect.value==="down")updateBpm(bpm-step);}}}timerID=setTimeout(scheduler,lookahead);}
    async function startMetronome(){if(running)return;if(!audioCtx)audioCtx=new (window.AudioContext||window.webkitAudioContext)();try{await audioCtx.resume();}catch{}await loadSamplesOnce();updateBpm(parseInt(bpmSlider.value,10));beatsPerMeasure=parseInt(beatsSelect.value,10);rampSelect.dispatchEvent(new Event("change"));currentBeat=0;barCounter=0;nextNoteTime=audioCtx.currentTime+0.05;running=true;toggleBtn.textContent="Stop";toggleBtn.className="stop";scheduler();}
    function stopMetronome(){running=false;if(timerID)clearTimeout(timerID);toggleBtn.textContent="Start";toggleBtn.className="start";}
    toggleBtn.addEventListener("click",()=>{running?stopMetronome():startMetronome();});
    document.addEventListener("keydown",(e)=>{if(e.code==="Space"){e.preventDefault();running?stopMetronome():startMetronome();}if(e.code==="ArrowLeft"||e.code==="ArrowDown"){e.preventDefault();updateBpm(bpm-(e.shiftKey?5:1));}if(e.code==="ArrowRight"||e.code==="ArrowUp"){e.preventDefault();updateBpm(bpm+(e.shiftKey?5:1));}if(e.code==="KeyT"){e.preventDefault();tapBtn.click();}});
    document.getElementById("darkSwitch").addEventListener("change",(e)=>{document.body.classList.toggle("dark-mode",e.target.checked);});
    updateBpm(parseInt(bpmSlider.value,10));rampSelect.dispatchEvent(new Event("change"));
  </script>
</body>
</html>
