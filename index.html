<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ruud's Bass Metronome</title>

  <!-- Prevent caching -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", Arial, sans-serif;
      background:#fff; color:#111; margin:0; padding:20px;
      display:flex; flex-direction:column; align-items:center;
      transition: background 0.3s, color 0.3s;
    }
    h1 { font-size:1.8rem; font-weight:600; margin-bottom:40px; text-align:center; }

    .control-row {
      display:flex; flex-wrap:wrap; align-items:center; justify-content:center;
      gap:8px; margin:12px 0 20px; width:100%; max-width:650px;
    }
    .bpm-group, .other-group { display:flex; flex-wrap:nowrap; align-items:center; gap:6px; }
    .bpm-group { flex:2; } .other-group { flex:1; }
    .bpm-control { display:flex; align-items:center; gap:4px; flex:1; }
    .bpm-btn {
      padding:0 12px; height:32px; min-width:32px; border-radius:6px; border:1px solid #ccc;
      background:#f5f5f5; font-size:1rem; font-weight:500; cursor:pointer; color:#111;
      transition: background 0.3s, color 0.3s, border-color 0.3s;
    }
    .bpm-btn:hover { background:#e0e0e0; transform:scale(1.03); }
    input[type=range] { flex:1; min-width:100px; }
    input[type=number], select {
      padding:6px 8px; border:1px solid #ccc; border-radius:6px;
      font-size:0.9rem; background:#fafafa; color:#111; transition: background 0.3s, color 0.3s, border-color 0.3s;
    }
    input[type=number] { width:60px; text-align:center; }

    /* Switch */
    .switch { position:relative; display:inline-block; width:46px; height:24px; }
    .switch input { display:none; }
    .slider {
      position:absolute; cursor:pointer; top:0; left:0; right:0; bottom:0;
      background:#ccc; border-radius:24px; transition:.3s;
    }
    .slider:before {
      position:absolute; content:""; height:18px; width:18px; left:3px; bottom:3px;
      background:white; border-radius:50%; transition:.3s;
    }
    input:checked + .slider { background:#34A853; }
    input:checked + .slider:before { transform:translateX(22px); }

    .buttons { margin-top:20px; display:flex; gap:12px; justify-content:center; }
    button { padding:10px 20px; border:none; border-radius:9999px; font-size:1rem; cursor:pointer; color:white; transition: background 0.3s; }
    #startBtn { background:#34A853; } #startBtn:hover { background:#0F9D58; }
    #stopBtn { background:#EA4335; } #stopBtn:hover { background:#C5221F; }

    @media (max-width:600px){
      .control-row{flex-direction:column; align-items:stretch;}
      .bpm-group,.other-group{justify-content:center;width:100%;}
    }

    /* ðŸŒ™ Dark mode styles */
    body.dark-mode { background:#121212; color:#eee; }
    body.dark-mode .bpm-btn { background:#333; color:#eee; border-color:#555; }
    body.dark-mode .bpm-btn:hover { background:#444; }
    body.dark-mode input[type=number],
    body.dark-mode select { background:#222; color:#eee; border-color:#555; }
  </style>
</head>
<body>
  <h1>Ruudâ€™s Bass Metronome</h1>

  <!-- Controls -->
  <div class="control-row">
    <div class="bpm-group">
      <div class="bpm-control">
        <button class="bpm-btn" id="bpmDown">â€“</button>
        <input type="range" id="bpmSlider" min="30" max="300" value="100">
        <button class="bpm-btn" id="bpmUp">+</button>
      </div>
      <input type="number" id="bpmInput" min="30" max="300" value="100">
    </div>
    <div class="other-group">
      <select id="beats">
        <option value="2">2/4</option>
        <option value="3">3/4</option>
        <option value="4" selected>4/4</option>
        <option value="5">5/4</option>
        <option value="6">6/8</option>
      </select>
      <select id="ramp">
        <option value="off">Ramp off</option>
        <option value="up">Ramp up</option>
        <option value="down">Ramp down</option>
      </select>
      <select id="rampStep" style="display:none;">
        <option value="1">1</option>
        <option value="2">2</option>
        <option value="3">3</option>
        <option value="4">4</option>
        <option value="5">5</option>
      </select>
    </div>
  </div>

  <!-- Slap + Dark Mode inline -->
  <div style="margin:10px 0; display:flex; align-items:center; gap:20px;">
    <div style="display:flex; align-items:center; gap:8px;">
      <span>Slap</span>
      <label class="switch">
        <input type="checkbox" id="slapSwitch">
        <span class="slider"></span>
      </label>
    </div>
    <div style="display:flex; align-items:center; gap:8px;">
      <span>Dark Mode</span>
      <label class="switch">
        <input type="checkbox" id="darkSwitch">
        <span class="slider"></span>
      </label>
    </div>
  </div>

  <!-- Transport -->
  <div class="buttons">
    <button id="startBtn" onclick="startMetronome()">Start</button>
    <button id="stopBtn" onclick="stopMetronome()">Stop</button>
  </div>

  <script>
    // Version check (bump this number each time you deploy)
    const VERSION = "1.0.1";
    const lastVersion = localStorage.getItem("metronome_version");
    if (lastVersion && lastVersion !== VERSION) {
      console.log("New version detected, reloading...");
      localStorage.setItem("metronome_version", VERSION);
      location.reload(true);
    } else {
      localStorage.setItem("metronome_version", VERSION);
    }

    let audioCtx = null;
    let baseBuffer = null;
    let slapNormalBuffer = null;
    let slapAccentBuffer = null;
    let samplesReady = false;

    const BASE_URL = "https://raw.githubusercontent.com/rpmoers/ruuds-metronome/main/metronome-85688.mp3";
    const SLAP_NORMAL_URL = "https://raw.githubusercontent.com/rpmoers/ruuds-metronome/main/Alesis-S4-Plus-Muted-Pops-C3.wav";
    const SLAP_ACCENT_URL = "https://raw.githubusercontent.com/rpmoers/ruuds-metronome/main/Korg-N1R-Slap-It-C1.wav";

    async function loadSample(url) {
      const res = await fetch(url);
      if (!res.ok) throw new Error("HTTP " + res.status);
      const arr = await res.arrayBuffer();
      return await audioCtx.decodeAudioData(arr);
    }

    async function loadSamplesOnce() {
      if (samplesReady) return;
      if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      try {
        baseBuffer = await loadSample(BASE_URL);
        slapNormalBuffer = await loadSample(SLAP_NORMAL_URL);
        slapAccentBuffer = await loadSample(SLAP_ACCENT_URL);
        samplesReady = true;
      } catch (e) {
        console.error("Error loading samples:", e);
      }
    }

    function playClick(accent=false, time=0) {
      if (!audioCtx || !samplesReady) return;
      const slapMode = document.getElementById("slapSwitch").checked;
      let src = audioCtx.createBufferSource();
      let gainNode = audioCtx.createGain();

      if (slapMode) {
        // Slap mode: Muted Pops for normal, Slap-It for accents
        src.buffer = accent ? slapAccentBuffer : slapNormalBuffer;
        gainNode.gain.value = 1.0;
      } else {
        // Normal mode: base sample, accent louder + pitched
        src.buffer = baseBuffer;
        gainNode.gain.value = accent ? 1.6 : 1.0;
        src.playbackRate.value = accent ? 1.1 : 1.0;
      }

      src.connect(gainNode).connect(audioCtx.destination);
      src.start(time);
    }

    // ===== State =====
    let running=false, bpm=100, beatsPerMeasure=4, currentBeat=0, barCounter=0, nextNoteTime=0.0, timerID;
    const bpmSlider=document.getElementById("bpmSlider");
    const bpmInput=document.getElementById("bpmInput");
    const bpmUp=document.getElementById("bpmUp");
    const bpmDown=document.getElementById("bpmDown");
    const beatsSelect=document.getElementById("beats");
    const rampSelect=document.getElementById("ramp");
    const rampStep=document.getElementById("rampStep");

    function clamp(v,lo,hi){return Math.min(hi,Math.max(lo,v||0));}
    function updateBpm(val){ bpm=clamp(val,30,300); bpmSlider.value=bpm; bpmInput.value=bpm; }
    bpmSlider.addEventListener("input",()=>updateBpm(parseInt(bpmSlider.value,10)));
    bpmInput.addEventListener("change",()=>{const v=parseInt(bpmInput.value,10); if(!isNaN(v)) updateBpm(v);});
    bpmUp.addEventListener("click",()=>updateBpm(bpm+1));
    bpmDown.addEventListener("click",()=>updateBpm(bpm-1));
    beatsSelect.addEventListener("change",()=>{beatsPerMeasure=parseInt(beatsSelect.value,10); currentBeat=0;});

    rampSelect.addEventListener("change",()=>{
      rampStep.style.display=(rampSelect.value==="up"||rampSelect.value==="down")?"inline-block":"none";
    });

    // Scheduler
    const lookahead=25.0, scheduleAheadTime=0.1;
    function nextNote(){ const secPerBeat=60.0/bpm; nextNoteTime+=secPerBeat; currentBeat=(currentBeat+1)%beatsPerMeasure; }
    function scheduleNote(beatNumber,time){ playClick(beatNumber===0,time); }
    function scheduler(){
      if(!running||!audioCtx)return;
      while(nextNoteTime<audioCtx.currentTime+scheduleAheadTime){
        scheduleNote(currentBeat,nextNoteTime);
        nextNote();
        if(currentBeat===0){
          barCounter++;
          if(barCounter%4===0){
            const step=parseInt(rampStep.value||"1",10);
            if(rampSelect.value==="up") updateBpm(bpm+step);
            if(rampSelect.value==="down") updateBpm(bpm-step);
          }
        }
      }
      timerID=setTimeout(scheduler,lookahead);
    }

    async function startMetronome(){
      if(running) return;
      if(!audioCtx) audioCtx=new (window.AudioContext||window.webkitAudioContext)();
      try{ await audioCtx.resume(); }catch{}
      await loadSamplesOnce();   // âœ… ensure samples load before start
      updateBpm(parseInt(bpmSlider.value,10));
      beatsPerMeasure=parseInt(beatsSelect.value,10);
      currentBeat=0; barCounter=0; nextNoteTime=audioCtx.currentTime+0.05;
      running=true; scheduler();
    }
    function stopMetronome(){ running=false; if(timerID) clearTimeout(timerID); }

    document.addEventListener("keydown",(e)=>{
      if(e.code==="Space"||e.code==="Enter"){ e.preventDefault(); running?stopMetronome():startMetronome(); }
    });

    // Dark mode switch
    const darkSwitch = document.getElementById("darkSwitch");
    darkSwitch.addEventListener("change", () => {
      document.body.classList.toggle("dark-mode", darkSwitch.checked);
    });

    window.startMetronome=startMetronome; window.stopMetronome=stopMetronome;
  </script>
</body>
</html>
