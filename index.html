<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üéµ</text></svg>">
  <title>MetRuudnome</title>

  <style>
    :root {
      --gray-100: #f9f9f9;
      --gray-200: #f6f6f6;
      --gray-400: #bdbdbd;
      --gray-500: #9e9e9e;
      --gray-600: #757575;
      --gray-700: #555;
      --gray-800: #424242;
      --gray-900: #212121;
      --accent-green: #34A853;
      --accent-green-dark: #0F9D58;
      --accent-red: #EA4335;
      --accent-red-dark: #C5221F;
      --wrap-max: 420px;
      --section-gap: 28px;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", Arial, sans-serif;
      background: var(--gray-100);
      color: var(--gray-900);
      margin: 0;
      padding: 24px 16px;
      display: flex;
      flex-direction: column;
      align-items: center;
      transition: background 0.3s, color 0.3s;
      -webkit-user-select: none;
      user-select: none;
    }

    .wrap {
      width: 100%;
      max-width: var(--wrap-max);
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      box-sizing: border-box;
    }

    h1 {
      font-size: 2rem;
      font-weight: 600;
      margin: 0 0 var(--section-gap) 0;
      text-align: center;
      color: var(--gray-800);
      width: 100%;
    }

    h2 {
      font-size: 1rem;
      font-weight: 600;
      color: var(--gray-800);
      margin: 0 0 6px 4px;
    }

    section {
      width: 100%;
      margin-bottom: var(--section-gap);
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .switches, .tempo-settings {
      display: flex;
      align-items: center;
      justify-content: flex-start;
      gap: 12px;
      width: 100%;
      flex-wrap: wrap;
    }

    .tempo-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      width: 100%;
    }

    .sound-row {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 100%;
    }

    .switch-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .switch-label {
      font-size: 0.9rem;
      line-height: 1;
    }

    /* --- Cross-browser consistent sliders --- */
    input[type=range] {
      flex: 1;
      appearance: none;
      height: 8px;
      border-radius: 4px;
      background: var(--gray-400);
      cursor: pointer;
      outline: none;
      width: 100%;
    }
    input[type=range]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: var(--accent-green);
      border: none;
      margin-top: -5px;
      transition: background 0.3s;
    }
    input[type=range]::-webkit-slider-thumb:hover { background: var(--accent-green-dark); }
    input[type=range]::-moz-range-thumb {
      width: 18px; height: 18px; border-radius: 50%;
      background: var(--accent-green); border: none; transition: background 0.3s;
    }
    input[type=range]::-moz-range-thumb:hover { background: var(--accent-green-dark); }
    input[type=range]::-moz-range-track {
      height: 8px; border-radius: 4px; background: var(--gray-400);
    }

    /* --- Inputs, selects, and buttons --- */
    #bpmInput, #tapTempo, select {
      height: 36px;
      line-height: 1;
      padding: 0 10px;
      border: 1px solid var(--gray-400);
      border-radius: 6px;
      font-size: 0.9rem;
      background: var(--gray-100);
      color: var(--gray-900);
      cursor: pointer;
      box-sizing: border-box;
      transition: background 0.3s, color 0.3s, border-color 0.3s;
    }
    #bpmInput { width: 70px; text-align: center; }
    #tapTempo { min-width: 80px; }
    #tapTempo:hover { background: var(--gray-400); color: var(--gray-100); }

    #accentBeat { width: auto; min-width: 90px; max-width: fit-content; align-self: flex-start; }

    /* Switch */
    .switch { position: relative; width: 46px; height: 24px; }
    .switch input { display: none; }
    .slider {
      position: absolute; inset: 0;
      background: var(--gray-400);
      border-radius: 24px; transition: background 0.3s;
    }
    .slider:before {
      content: "";
      position: absolute;
      height: 18px; width: 18px;
      left: 3px; bottom: 3px;
      background: var(--gray-100);
      border-radius: 50%;
      transition: .3s;
    }
    input:checked + .slider { background: var(--accent-green); }
    input:checked + .slider:before { transform: translateX(22px); }

    /* Start/Stop */
    .buttons { display: flex; justify-content: center; width: 100%; }
    #toggleBtn {
      padding: 16px 48px;
      border-radius: 9999px;
      font-size: 1.2rem;
      font-weight: 500;
      border: none;
      cursor: pointer;
      transition: background 0.3s;
    }
    #toggleBtn.start { background: var(--accent-green); color: white; }
    #toggleBtn.start:hover { background: var(--accent-green-dark); }
    #toggleBtn.stop { background: var(--accent-red); color: white; }
    #toggleBtn.stop:hover { background: var(--accent-red-dark); }

    /* Instructions */
.instructions {
  font-size: 0.85rem;
  background: var(--gray-100);
  color: var(--gray-700);
  border: none;
  text-align: left;
  padding: 14px 18px;
  border-radius: 8px;
  width: 100%;
  box-sizing: border-box;
}

.shortcuts {
  border-collapse: collapse;
  width: 100%;
  margin-top: 6px;
}

.shortcuts td {
  padding: 4px 0;
  vertical-align: middle;
  border: none;
}

.key {
  font-weight: 600;
  color: var(--gray-800);
  width: 140px;
  white-space: nowrap;
}

.desc {
  color: var(--gray-700);
}

/* Dark mode */
body.dark-mode .instructions {
  background: var(--gray-900);
  color: var(--gray-100);
}

body.dark-mode .key {
  color: var(--gray-100);
}

body.dark-mode .desc {
  color: var(--gray-400);
}

        footer {
  width: 100%;
  text-align: center;
  font-size: 0.75rem;
  color: var(--gray-600);
  margin-top: 32px;
  padding-top: 12px;
}

    /* Dark mode */
    body.dark-mode { background: var(--gray-900); color: var(--gray-100); }
    body.dark-mode h1, body.dark-mode h2 { color: var(--gray-100); }
    body.dark-mode #bpmInput, body.dark-mode #tapTempo, body.dark-mode select {
      background: var(--gray-800); color: var(--gray-100); border-color: var(--gray-600);
    }
    body.dark-mode input[type=range] { background: var(--gray-600); }
        /* Fix switch colors in dark mode */
    body.dark-mode .slider {
      background: var(--gray-700);
    }
    body.dark-mode .slider:before {
      background: var(--gray-200);
    }
    body.dark-mode input:checked + .slider {
      background: var(--accent-green);
    }
    body.dark-mode .instructions {
      color: #f6f6f6; background: var(--gray-900); border: 1px solid var(--gray-600);
    }

body.dark-mode footer {
  color: var(--gray-600);
}
  </style>
</head>

<body>
  <div class="wrap">
    <h1>MetRuudnome</h1>

    <section>
      <h2>Style</h2>
      <div class="switches">
        <div class="switch-item">
          <label class="switch">
            <input type="checkbox" id="slapSwitch">
            <span class="slider"></span>
          </label>
          <span class="switch-label">Slap</span>
        </div>
        <div class="switch-item">
          <label class="switch">
            <input type="checkbox" id="darkSwitch">
            <span class="slider"></span>
          </label>
          <span class="switch-label">Dark Mode</span>
        </div>
      </div>
    </section>

    <section>
      <h2>Sound</h2>
      <div class="sound-row">
        <input type="range" id="volume" min="0" max="100" value="80">
      </div>
    </section>

    <section>
      <h2>Tempo</h2>
      <div class="tempo-row">
        <input type="range" id="bpmSlider" min="30" max="300" value="100">
        <input type="number" id="bpmInput" min="30" max="300" value="100">
        <button id="tapTempo">Tap</button>
      </div>
      <div class="tempo-settings">
        <select id="beats" title="Time Signature">
          <option value="2">2/4</option>
          <option value="3">3/4</option>
          <option value="4" selected>4/4</option>
          <option value="5">5/4</option>
          <option value="6">6/8</option>
          <option value="7">7/8</option>
          <option value="9">9/8</option>
          <option value="12">12/8</option>
        </select>
        <select id="ramp">
          <option value="off" selected>Ramp Off</option>
          <option value="up">Ramp Up</option>
          <option value="down">Ramp Down</option>
        </select>
        <select id="rampStep" style="display:none;">
          <option value="1">+1</option>
          <option value="2">+2</option>
          <option value="3">+3</option>
          <option value="4">+4</option>
          <option value="5">+5</option>
        </select>
      </div>
    </section>

    <section>
      <h2>Accent</h2>
      <select id="accentBeat"></select>
    </section>

    <section>
      <div class="buttons">
        <button id="toggleBtn" class="start">Start</button>
      </div>
    </section>

    <section>
      <div class="instructions">
        <h2 style="margin-top:0;">Keyboard Shortcuts</h2>
        <table class="shortcuts">
          <tr><td class="key">Spacebar</td><td class="desc">Start / Stop</td></tr>
          <tr><td class="key">Arrow ‚Üë ‚Üì</td><td class="desc">Decrease tempo</td></tr>
          <tr><td class="key">Arrow ‚Üí ‚Üë</td><td class="desc">Increase tempo</td></tr>
          <tr><td class="key">Shift + ‚Üê ‚Üë ‚Üí ‚Üì</td><td class="desc">Change tempo faster</td></tr>
          <tr><td class="key">T</td><td class="desc">Tap to set tempo</td></tr>
          <tr><td class="key">+</td><td class="desc">Increase volume</td></tr>
          <tr><td class="key">‚àí</td><td class="desc">Decrease volume</td></tr>
        </table>
      </div>
    </section>
  </div>

  <script>
    let audioCtx=null, baseBuffer=null, slapNormalBuffer=null, slapAccentBuffer=null, samplesReady=false;
    const BASE_URL="https://raw.githubusercontent.com/rpmoers/ruuds-metronome/main/metronome-85688.mp3";
    const SLAP_NORMAL_URL="https://raw.githubusercontent.com/rpmoers/ruuds-metronome/main/Alesis-S4-Plus-Muted-Pops-C3.wav";
    const SLAP_ACCENT_URL="https://raw.githubusercontent.com/rpmoers/ruuds-metronome/main/Korg-N1R-Slap-It-C1.wav";

    async function loadSample(url){const res=await fetch(url);if(!res.ok) throw new Error("HTTP "+res.status);const arr=await res.arrayBuffer();return await audioCtx.decodeAudioData(arr);}
    async function loadSamplesOnce(){if(samplesReady)return;if(!audioCtx) audioCtx=new (window.AudioContext||window.webkitAudioContext)();baseBuffer=await loadSample(BASE_URL);slapNormalBuffer=await loadSample(SLAP_NORMAL_URL);slapAccentBuffer=await loadSample(SLAP_ACCENT_URL);samplesReady=true;}

    const bpmSlider=document.getElementById("bpmSlider"),bpmInput=document.getElementById("bpmInput"),
          beatsSelect=document.getElementById("beats"),rampSelect=document.getElementById("ramp"),
          rampStep=document.getElementById("rampStep"),accentSelect=document.getElementById("accentBeat"),
          toggleBtn=document.getElementById("toggleBtn"),tapBtn=document.getElementById("tapTempo"),
          volumeSlider=document.getElementById("volume");

    let running=false,bpm=100,currentBeat=0,beatsPerMeasure=4,nextNoteTime=0.0,timerID,
        masterVolume=0.8,accentBeat=0,barCounter=0;

    function clamp(v,lo,hi){return Math.min(hi,Math.max(lo,v||0));}
    function updateBpm(val){bpm=clamp(val,30,300);bpmSlider.value=bpm;bpmInput.value=bpm;}
    function updateVolume(v){masterVolume=clamp(v,0,1);volumeSlider.value=masterVolume*100;}

    function updateRampLabels(direction){
      const signs = direction === "down" ? "-" : "+";
      const steps = [1,2,3,4,5].map(s => `<option value="${s}">${signs}${s}</option>`).join("");
      rampStep.innerHTML = steps;
      rampStep.style.display = direction === "off" ? "none" : "inline-block";
    }

    // ---- Accent options (single source of truth) ----
    function updateAccentOptions() {
      // remember previous, allow -1 ("None") to persist
      let prev = parseInt(accentSelect.value, 10);
      if (isNaN(prev)) prev = -1;

      accentSelect.innerHTML = '';
      for (let i = 0; i < beatsPerMeasure; i++) {
        const opt = document.createElement('option');
        opt.value = i;
        opt.textContent = `Beat ${i + 1}`;
        accentSelect.appendChild(opt);
      }
      const none = document.createElement('option');
      none.value = -1;
      none.textContent = 'None';
      accentSelect.appendChild(none);

      // restore previous selection (including -1), else default to Beat 1
      let restore;
      if (prev === -1) restore = -1;
      else if (prev >= 0 && prev < beatsPerMeasure) restore = prev;
      else restore = 0;

      accentSelect.value = String(restore);
      accentBeat = restore;
    }

    beatsSelect.addEventListener("change",()=>{
      beatsPerMeasure=parseInt(beatsSelect.value,10);
      updateAccentOptions();
      currentBeat = 0;
    });

    rampSelect.addEventListener("change",()=>{
      updateRampLabels(rampSelect.value);
    });

    function playClick(accent=false,time=0){
      if(!audioCtx||!samplesReady)return;
      const slapMode=document.getElementById("slapSwitch").checked;
      const src=audioCtx.createBufferSource();
      const gain=audioCtx.createGain();

      if (slapMode) {
        src.buffer = accent ? slapAccentBuffer : slapNormalBuffer;
        gain.gain.value = masterVolume;
      } else {
        src.buffer = baseBuffer;
        gain.gain.value = accent ? masterVolume * 1.6 : masterVolume;
        src.playbackRate.value = accent ? 1.1 : 1.0;
      }

      src.connect(gain).connect(audioCtx.destination);
      src.start(time);
    }

    const lookahead=25.0,scheduleAheadTime=0.1;
    function nextNote(){const secPerBeat=60.0/bpm;nextNoteTime+=secPerBeat;currentBeat=(currentBeat+1)%beatsPerMeasure;}
    function scheduleNote(beat,time){const isAccent=(accentBeat!==-1&&beat===accentBeat);playClick(isAccent,time);}
    function scheduler(){
      if(!running||!audioCtx)return;
      while(nextNoteTime<audioCtx.currentTime+scheduleAheadTime){
        scheduleNote(currentBeat,nextNoteTime);
        nextNote();
        if(currentBeat===0){
          barCounter++;
          if(barCounter%4===0){
            const step=parseInt(rampStep.value||"1",10);
            if(rampSelect.value==="up")updateBpm(bpm+step);
            if(rampSelect.value==="down")updateBpm(bpm-step);
          }
        }
      }
      timerID=setTimeout(scheduler,lookahead);
    }

    async function startMetronome(){
      if(running)return;
      if(!audioCtx)audioCtx=new (window.AudioContext||window.webkitAudioContext)();
      try{await audioCtx.resume();}catch{}
      await loadSamplesOnce();
      updateBpm(parseInt(bpmSlider.value,10));
      beatsPerMeasure=parseInt(beatsSelect.value,10);
      updateAccentOptions(); // preserves current selection, including "None"
      currentBeat=0; barCounter=0;
      nextNoteTime=audioCtx.currentTime+0.05;
      running=true;
      toggleBtn.textContent="Stop"; toggleBtn.className="stop";
      scheduler();
    }
    function stopMetronome(){
      running=false;
      if(timerID)clearTimeout(timerID);
      toggleBtn.textContent="Start"; toggleBtn.className="start";
    }

    toggleBtn.addEventListener("click",()=>{running?stopMetronome():startMetronome();});
    bpmSlider.addEventListener("input",()=>updateBpm(parseInt(bpmSlider.value,10)));
    bpmInput.addEventListener("change",()=>{const v=parseInt(bpmInput.value,10);if(!isNaN(v)) updateBpm(v);});
    accentSelect.addEventListener("change",()=>{accentBeat=parseInt(accentSelect.value,10);});
    volumeSlider.addEventListener("input",()=>updateVolume(volumeSlider.value/100));

    // Dark mode: apply on load and persist on change
    const darkSaved = localStorage.getItem("darkMode") === "true";
    document.getElementById("darkSwitch").checked = darkSaved;
    document.body.classList.toggle("dark-mode", darkSaved);
    document.getElementById("darkSwitch").addEventListener("change",(e)=>{
      const isDark = e.target.checked;
      document.body.classList.toggle("dark-mode", isDark);
      localStorage.setItem("darkMode", String(isDark));
    });

    // Tap tempo (average of last up to 4 taps)
    let lastTap=0,tapIntervals=[];
    tapBtn.addEventListener("click",()=>{
      const now=Date.now();
      if(lastTap){
        tapIntervals.push(now-lastTap);
        if(tapIntervals.length>4) tapIntervals.shift();
        const avg=tapIntervals.reduce((a,b)=>a+b,0)/tapIntervals.length;
        const calc=Math.round(60000/avg);
        if(calc>0&&isFinite(calc)) updateBpm(calc);
      }
      lastTap=now;
    });

    document.addEventListener("keydown",(e)=>{
      if(e.code==="Space"){e.preventDefault();running?stopMetronome():startMetronome();}
      if(e.code==="ArrowLeft"||e.code==="ArrowDown"){e.preventDefault();updateBpm(bpm-(e.shiftKey?5:1));}
      if(e.code==="ArrowRight"||e.code==="ArrowUp"){e.preventDefault();updateBpm(bpm+(e.shiftKey?5:1));}
      if(e.code==="Minus"){e.preventDefault();updateVolume(masterVolume-0.05);}
      if(e.code==="Equal"||e.code==="NumpadAdd"){e.preventDefault();updateVolume(masterVolume+0.05);}
      if(e.code==="KeyT"){e.preventDefault();tapBtn.click();}
    });

    // Init UI state
    updateRampLabels(rampSelect.value);
    updateAccentOptions();
    
    // --- Persist user settings (accent, ramp, rampStep) ---
window.addEventListener("beforeunload", () => {
  localStorage.setItem("accentBeat", accentSelect.value);
  localStorage.setItem("rampDirection", rampSelect.value);
  localStorage.setItem("rampStep", rampStep.value);
});

// --- Restore on load ---
window.addEventListener("DOMContentLoaded", () => {
  // Restore ramp direction
  const savedRamp = localStorage.getItem("rampDirection");
  if (savedRamp) {
    rampSelect.value = savedRamp;
    updateRampLabels(savedRamp);
  }

  // Restore ramp step
  const savedStep = localStorage.getItem("rampStep");
  if (savedStep) {
    rampStep.value = savedStep;
  }

  // Restore accent
  const savedAccent = localStorage.getItem("accentBeat");
  if (savedAccent !== null) {
    accentSelect.value = savedAccent;
    accentBeat = parseInt(savedAccent, 10);
  }
});
  </script>
    <footer>
    <p>Ruud ‚Äî 2025</p>
  </footer>
</body>
</html>
